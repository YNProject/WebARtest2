<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ginza Sakura Sky - Fixed & Vivid Edition</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 9999; color: white; flex-direction: column;
        font-family: sans-serif; text-align: center;
      }
      #start-btn {
        padding: 15px 35px; font-size: 18px; background: #FFB6C1;
        border: none; border-radius: 30px; cursor: pointer; color: #444; font-weight: bold;
      }
      #shutter-wrapper {
        position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
        display: none; align-items: center; justify-content: center; z-index: 10000;
      }
      #shutter-btn {
        width: 76px; height: 76px; background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white;
      }
      #shutter-btn-inner { width: 60px; height: 60px; background-color: white; border-radius: 50%; }
      .instruction-text {
        position: fixed; top: 10%; width: 100%; text-align: center;
        color: white; font-family: sans-serif; text-shadow: 1px 1px 4px black;
        z-index: 9998; display: none;
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <div id="overlay">
      <h2 style="margin-bottom: 10px;">銀座の街に桜を咲かせよう</h2>
      <p style="margin-bottom: 20px;">好きな場所をタップして<br>桜を植えてください</p>
      <button id="start-btn">ARを開始する</button>
    </div>

    <div id="instruction" class="instruction-text">地面のあたりをタップして桜を植えよう</div>

    <div id="shutter-wrapper">
      <div id="shutter-btn"><div id="shutter-btn-inner"></div></div>
    </div>

    <a-scene id="scene" embedded vr-mode-ui="enabled: false" 
              arjs="sourceType: webcam; debugUIEnabled: false;"
              screenshot
              gl="preserveDrawingBuffer: true;">
      
      <a-assets>
        <img id="sakura-white-img" src="img/sakuraWhite.png">
        <img id="cloud-img" src="img/cloud.png">
        <img id="kage-img" src="img/kage.png">
        <a-asset-item id="sakura-tree-model" src="model/sakura.glb"></a-asset-item>

        <a-mixin id="petal" geometry="primitive: plane; width: 0.45; height: 0.45" 
                  material="src: #sakura-white-img; transparent: true; alphaTest: 0.5; side: double; shader: flat"></a-mixin>
        <a-mixin id="cloud-mixin" material="src: #cloud-img; transparent: true; alphaTest: 0.1; side: double; shader: flat; depthTest: false;"></a-mixin>
      </assets>

      <a-entity id="sakura-anchor" visible="false">
        <a-entity id="sakura-tree" gltf-model="#sakura-tree-model" scale="1.5 1.5 1.5" position="0 0 0"></a-entity>
        <a-image src="#kage-img" rotation="-90 0 0" position="0 0.05 0" scale="6 6 6" transparent="true" opacity="0.7"></a-image>
      </a-entity>

      <a-entity id="ambient-light" light="type: ambient; color: #ffffff; intensity: 1.0"></a-entity>

      <a-entity camera look-controls="enabled: true; touchEnabled: false;" far="1000"></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('#scene');
      const startBtn = document.querySelector('#start-btn');
      const overlay = document.querySelector('#overlay');
      const instruction = document.querySelector('#instruction');
      const shutterWrapper = document.querySelector('#shutter-wrapper');
      const sakuraAnchor = document.querySelector('#sakura-anchor');

      const MAX_PETALS = 150; // 花びらが大きくなったので、数を少し絞ると綺麗です
      let petals = [];
      let treePlaced = false;
      let touchStartX = 0, touchStartY = 0;

      startBtn.addEventListener('click', function() {
        overlay.style.display = 'none';
        instruction.style.display = 'block';
        shutterWrapper.style.display = 'flex';
        initAR();
      });

      function initAR() {
        createClouds();
        updateLightingByTime();
      }

      window.addEventListener('mousedown', (e) => {
        if (overlay.style.display !== 'none' || e.target.closest('#shutter-wrapper')) return;

        if (!treePlaced) {
          const camera = document.querySelector('[camera]').object3D;
          camera.updateMatrixWorld();
          
          const direction = new THREE.Vector3(0, 0, -1);
          direction.applyQuaternion(camera.getWorldQuaternion(new THREE.Quaternion()));
          
          // 前方15mの地点に配置
          const distance = 15; 
          const worldPos = new THREE.Vector3();
          camera.getWorldPosition(worldPos);

          const targetX = worldPos.x + direction.x * distance;
          const targetZ = worldPos.z + direction.z * distance;

          // 地面（y=-8）に配置
          sakuraAnchor.setAttribute('position', `${targetX} -8 ${targetZ}`);
          sakuraAnchor.setAttribute('visible', 'true');
          treePlaced = true;
          
          instruction.innerText = "桜が植わりました！";
          setTimeout(() => { instruction.style.display = 'none'; }, 3000);

          for (let i = 0; i < MAX_PETALS; i++) { 
            setTimeout(() => createPetal(), Math.random() * 8000); 
          }
        }
        for (let i = 0; i < 10; i++) { createBurstPetal(); }
      });

      function createPetal() {
        if (!treePlaced) return;
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        
        const treePos = sakuraAnchor.getAttribute('position');
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * 12; 
        const x = parseFloat(treePos.x) + Math.cos(angle) * radius;
        const z = parseFloat(treePos.z) + Math.sin(angle) * radius;

        petal.setAttribute('position', `${x} 12 ${z}`);
        petal.setAttribute('material', `color: #FFB6C1; opacity: 0.9;`);
        
        const dur = 10000 + Math.random() * 5000;
        petal.setAttribute('animation__fall', { 
            property: 'position', to: `${x} -10 ${z}`, dur: dur, easing: 'linear' 
        });
        petal.setAttribute('animation__rotate', { 
            property: 'rotation', to: `${Math.random()*360} 720 ${Math.random()*360}`, dur: 5000, loop: true 
        });
        
        sceneEl.appendChild(petal);
        petals.push(petal);
        setTimeout(() => { 
          if (petal.parentNode) { 
            petal.parentNode.removeChild(petal); 
            petals = petals.filter(p => p !== petal); 
            createPetal(); 
          } 
        }, dur);
      }

      function createBurstPetal() {
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        petal.setAttribute('position', `0 1.5 -2`); // カメラの前から発生
        petal.setAttribute('rotation', `${Math.random()*360} ${Math.random()*360} ${Math.random()*360}`);
        
        const destX = (Math.random() - 0.5) * 15;
        const destZ = -15 - (Math.random() * 10);
        petal.setAttribute('animation__burst', { 
            property: 'position', to: `${destX} -8 ${destZ}`, dur: 5000, easing: 'easeOutQuad' 
        });
        
        sceneEl.querySelector('[camera]').appendChild(petal);
        setTimeout(() => { if (petal.parentNode) petal.parentNode.removeChild(petal); }, 5500);
      }

      function updateLightingByTime() {
        const hour = new Date().getHours();
        const light = document.querySelector('#ambient-light');
        if (hour >= 16 && hour < 18) light.setAttribute('light', 'color: #ffccaa; intensity: 0.8');
        else if (hour >= 18 || hour < 6) light.setAttribute('light', 'color: #8899ff; intensity: 0.6');
      }

      function createClouds() {
        for (let i = 0; i < 15; i++) {
          const cloud = document.createElement('a-entity');
          cloud.setAttribute('mixin', 'cloud-mixin');
          const angle = Math.random() * Math.PI * 2;
          const radius = 25 + Math.random() * 20;
          cloud.setAttribute('position', `${Math.cos(angle) * radius} ${10 + Math.random() * 5} ${Math.sin(angle) * radius}`);
          cloud.setAttribute('geometry', `primitive: plane; width: 18; height: 12`);
          sceneEl.appendChild(cloud);
        }
      }

      document.querySelector('#shutter-btn').addEventListener('click', function() {
        const video = document.querySelector('video');
        const aSceneCanvas = sceneEl.components.screenshot.getCanvas('perspective');
        const finalCanvas = document.createElement("canvas");
        finalCanvas.width = video.videoWidth; finalCanvas.height = video.videoHeight;
        const ctx = finalCanvas.getContext("2d");
        ctx.drawImage(video, 0, 0, finalCanvas.width, finalCanvas.height);
        ctx.drawImage(aSceneCanvas, 0, 0, finalCanvas.width, finalCanvas.height);
        const dataURL = finalCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `sakura.png`; link.href = dataURL; link.click();
      });
    </script>
  </body>
</html>