<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ginza Sakura Sky - World Fixed Edition</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 9999; color: white; flex-direction: column;
        font-family: sans-serif; text-align: center;
      }
      #start-btn {
        padding: 15px 35px; font-size: 18px; background: #FFB6C1;
        border: none; border-radius: 30px; cursor: pointer; color: #444; font-weight: bold;
      }
      #shutter-wrapper {
        position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
        display: none; align-items: center; justify-content: center; z-index: 10000;
      }
      #shutter-btn {
        width: 76px; height: 76px; background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white;
      }
      #shutter-btn-inner { width: 60px; height: 60px; background-color: white; border-radius: 50%; }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <div id="overlay">
      <h2 style="margin-bottom: 10px;">銀座の街に桜を咲かせよう</h2>
      <p style="margin-bottom: 20px;">場所を決めて画面をタップしてください</p>
      <button id="start-btn">ARを開始する</button>
    </div>

    <div id="shutter-wrapper">
      <div id="shutter-btn"><div id="shutter-btn-inner"></div></div>
    </div>

    <a-scene id="scene" embedded vr-mode-ui="enabled: false" 
              arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best; detectionMode: mono_and_matrix;"
              screenshot
              gl="preserveDrawingBuffer: true;">
      
      <a-assets>
        <img id="sakura-white-img" src="img/sakuraWhite.png">
        <img id="kage-img" src="img/kage.png">
        <a-asset-item id="sakura-tree-model" src="model/sakura.glb"></a-asset-item>
        <a-mixin id="petal" geometry="primitive: plane; width: 0.12; height: 0.12" 
                  material="src: #sakura-white-img; transparent: true; alphaTest: 0.6; side: double; shader: flat"></a-mixin>
      </a-assets>

      <a-entity id="sakura-anchor" visible="false">
        <a-entity id="sakura-tree" gltf-model="#sakura-tree-model" scale="1 1 1"></a-entity>
        <a-image src="#kage-img" rotation="-90 0 0" position="0 0.05 0" scale="5 5 5" transparent="true" opacity="0.4"></a-image>
      </a-entity>

      <a-entity id="camera-rig">
        <a-entity id="main-camera" camera look-controls="enabled: true;"></a-entity>
      </a-entity>

      <a-entity light="type: ambient; color: #ffffff; intensity: 1.2"></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('#scene');
      const startBtn = document.querySelector('#start-btn');
      const overlay = document.querySelector('#overlay');
      const sakuraAnchor = document.querySelector('#sakura-anchor');
      const cameraEl = document.querySelector('#main-camera');

      let treePlaced = false;

      startBtn.addEventListener('click', () => {
        overlay.style.display = 'none';
        document.querySelector('#shutter-wrapper').style.display = 'flex';
      });

      window.addEventListener('mousedown', (e) => {
        if (overlay.style.display !== 'none' || e.target.closest('#shutter-wrapper')) return;

        if (!treePlaced) {
          const screenY = e.clientY / window.innerHeight;
          const distance = 15 + (1 - Math.max(0.1, screenY)) * 45; 

          // カメラの「現在の世界での向き」を取得
          const cameraThree = cameraEl.object3D;
          const worldDirection = new THREE.Vector3(0, 0, -1);
          worldDirection.applyQuaternion(cameraThree.getWorldQuaternion(new THREE.Quaternion()));
          worldDirection.y = 0; // 地面に水平
          worldDirection.normalize();

          // カメラの「現在の世界での位置」を取得
          const worldPosition = new THREE.Vector3();
          cameraThree.getWorldPosition(worldPosition);

          // 新しい配置場所を計算（世界座標）
          const targetX = worldPosition.x + worldDirection.x * distance;
          const targetZ = worldPosition.z + worldDirection.z * distance;

          // アンカーをその世界座標にセット（カメラから独立した位置）
          sakuraAnchor.setAttribute('position', `${targetX} -5 ${targetZ}`);
          
          // 木を自分の方に向ける
          const lookAtAngle = Math.atan2(worldPosition.x - targetX, worldPosition.z - targetZ) * (180 / Math.PI);
          sakuraAnchor.setAttribute('rotation', `0 ${lookAtAngle} 0`);
          
          sakuraAnchor.setAttribute('visible', 'true');
          treePlaced = true;

          // 花びら生成（世界座標に降らせる）
          for (let i = 0; i < 150; i++) { createPetalWorld(targetX, targetZ); }
        }
      });

      function createPetalWorld(tx, tz) {
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        const x = tx + (Math.random() - 0.5) * 15;
        const z = tz + (Math.random() - 0.5) * 15;
        petal.setAttribute('position', `${x} 10 ${z}`);
        petal.setAttribute('material', `color: #FFB6C1; opacity: 0.9;`);
        
        const dur = 8000 + Math.random() * 5000;
        petal.setAttribute('animation__fall', { property: 'position', to: `${x} -5 ${z}`, dur: dur, easing: 'linear' });
        
        sceneEl.appendChild(petal);
        setTimeout(() => { 
          if (petal.parentNode) {
            petal.parentNode.removeChild(petal);
            createPetalWorld(tx, tz);
          }
        }, dur);
      }
      
      // （撮影機能は前述のコードと同様）
    </script>
  </body>
</html>