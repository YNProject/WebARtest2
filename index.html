<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ginza Sakura Sky - Camera Edition</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      /* スタート画面のオーバーレイ */
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 9999; color: white; flex-direction: column;
        font-family: sans-serif;
      }
      #start-btn {
        padding: 15px 35px; font-size: 18px; background: #FFB6C1;
        border: none; border-radius: 30px; cursor: pointer; color: #444; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }

      /* iPhone風シャッターボタンのレイアウト */
      #shutter-wrapper {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        display: none; /* 初期は非表示 */
        align-items: center;
        justify-content: center;
        z-index: 10000;
        transition: opacity 0.3s;
      }

      #shutter-btn {
        width: 76px;
        height: 76px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 4px solid white;
        cursor: pointer;
      }

      #shutter-btn-inner {
        width: 60px;
        height: 60px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.1s;
      }

      #shutter-btn:active #shutter-btn-inner {
        transform: scale(0.9);
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <div id="overlay">
      <h2 style="margin-bottom: 20px;">銀座の空に桜を広げます</h2>
      <button id="start-btn">ARを開始する</button>
    </div>

    <div id="shutter-wrapper">
      <div id="shutter-btn">
        <div id="shutter-btn-inner"></div>
      </div>
    </div>

    <a-scene id="scene" embedded vr-mode-ui="enabled: false" 
              arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;">
      
      <a-assets>
        <img id="sakura-white-img" src="img/sakuraWhite.png">
        <img id="cloud-img" src="img/cloud.png">
        
        <a-mixin id="petal" 
                  geometry="primitive: plane; width: 0.15; height: 0.15" 
                  material="src: #sakura-white-img; transparent: true; alphaTest: 0.8; side: double; shader: flat">
        </a-mixin>

        <a-mixin id="cloud-mixin"
                  material="src: #cloud-img; transparent: true; alphaTest: 0.1; side: double; shader: flat; depthTest: false;">
        </a-mixin>
      </a-assets>

      <a-entity camera look-controls="enabled: true" far="1000"></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('#scene');
      const startBtn = document.querySelector('#start-btn');
      const overlay = document.querySelector('#overlay');
      const shutterWrapper = document.querySelector('#shutter-wrapper');

      const MAX_PETALS = 400; 
      let petals = [];

      // AR開始処理
      startBtn.addEventListener('click', function() {
        overlay.style.display = 'none';
        shutterWrapper.style.display = 'flex';
        initAR();
      });

      function initAR() {
        createClouds();
        for (let i = 0; i < MAX_PETALS; i++) {
          setTimeout(() => createPetal(), Math.random() * 20000);
        }
        scheduleNextWind();
      }

      function getRandomSakuraColor() {
        const colors = ['#FFF0F5', '#FFE4E1', '#FFD1DC', '#FFC0CB', '#F8BBD0'];
        return colors[Math.floor(Math.random() * colors.length)];
      }

      // 雲の生成ロジック（軽量版レイヤー）
      function createClouds() {
        const layers = [
          { name: "遠景", radiusMin: 40, radiusMax: 90, count: 50, size: 6, opacity: 0.3, yMin: 4, yMax: 20 },
          { name: "中景", radiusMin: 20, radiusMax: 40, count: 40, size: 8, opacity: 0.5, yMin: 4, yMax: 15 },
          { name: "近景", radiusMin: 5, radiusMax: 18, count: 20, size: 16, opacity: 0.7, yMin: 4, yMax: 12 }
        ];

        layers.forEach(layer => {
          for (let i = 0; i < layer.count; i++) createCloudEntity(layer);
        });
      }

      function createCloudEntity(layer) {
        const cloud = document.createElement('a-entity');
        cloud.setAttribute('mixin', 'cloud-mixin');
        const angle = Math.random() * Math.PI * 2;
        const radius = layer.radiusMin + Math.random() * (layer.radiusMax - layer.radiusMin);
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        const y = layer.yMin + Math.random() * (layer.yMax - layer.yMin);
        
        cloud.setAttribute('position', `${x} ${y} ${z}`);
        const rotationY = (angle * 180 / Math.PI) * -1 + 90;
        cloud.setAttribute('rotation', `-10 ${rotationY} 0`);
        cloud.setAttribute('material', `color: ${getRandomSakuraColor()}; opacity: ${layer.opacity}`);
        cloud.setAttribute('geometry', `primitive: plane; width: ${layer.size}; height: ${layer.size * 0.7}`);
        sceneEl.appendChild(cloud);
      }

      // 花びらの生成ロジック
      function createPetal() {
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        const angle = Math.random() * Math.PI * 2;
        const radius = 2 + Math.random() * 16;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        const startY = 8 + Math.random() * 5;
        const endY = -10;
        
        petal.setAttribute('position', `${x} ${startY} ${z}`);
        petal.setAttribute('material', `color: ${getRandomSakuraColor()}; opacity: 0.95;`);
        
        const fallDuration = 12000 + Math.random() * 8000;
        petal.setAttribute('animation__fall', {
          property: 'position',
          to: `${x + (Math.random() - 0.5) * 4} ${endY} ${z + (Math.random() - 0.5) * 4}`,
          dur: fallDuration,
          easing: 'linear'
        });
        
        petal.setAttribute('animation__rotate', {
          property: 'rotation',
          to: `${Math.random() * 360} ${Math.random() * 720} ${Math.random() * 360}`,
          dur: 5000 + Math.random() * 3000,
          loop: true
        });
        
        sceneEl.appendChild(petal);
        petals.push(petal);
        
        setTimeout(() => {
          if (petal.parentNode) {
            petal.parentNode.removeChild(petal);
            petals = petals.filter(p => p !== petal);
            createPetal();
          }
        }, fallDuration);
      }

      function scheduleNextWind() {
        setTimeout(() => {
          blowWind();
          scheduleNextWind();
        }, 15000 + Math.random() * 10000);
      }

      function blowWind() {
        const windStrength = 15;
        const windAngle = Math.random() * Math.PI * 2;
        const windX = Math.cos(windAngle) * windStrength;
        const windZ = Math.sin(windAngle) * windStrength;
        petals.forEach(petal => {
          const currentPos = petal.getAttribute('position');
          petal.setAttribute('animation__fall', {
            to: `${currentPos.x + windX} -10 ${currentPos.z + windZ}`,
            dur: 7000,
            easing: 'easeOutQuad'
          });
        });
      }

      // シャッターボタンの動作：UIを一時的に隠して撮影を補助
document.querySelector('#shutter-btn').addEventListener('click', function() {
  const scene = document.querySelector('a-scene');
  // 1. A-Frame（桜部分）のCanvasを取得
  const aframeCanvas = scene.canvas;
  // 2. 背後のカメラ映像を取得
  const video = document.querySelector('video');

  // 3. 合成用のCanvasを作成
  const canvas = document.createElement('canvas');
  canvas.width = aframeCanvas.width;
  canvas.height = aframeCanvas.height;
  const ctx = canvas.getContext('2d');

  // 4. 背後の映像を描画（左右反転などの補正が必要な場合もあります）
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  // 5. その上に桜を描画
  ctx.drawImage(aframeCanvas, 0, 0, canvas.width, canvas.height);

  // 6. 画像として書き出し
  try {
    const dataURL = canvas.toDataURL('image/png');
    
    // ダウンロード用のリンクを作成
    const link = document.createElement('a');
    link.download = `ginza-sakura-${Date.now()}.png`;
    link.href = dataURL;
    
    // iOS/Android向けに、共有メニューや画像保存を促す
    if (navigator.share) {
      // 共有機能がある場合（スマホの標準共有）
      fetch(dataURL)
        .then(res => res.blob())
        .then(blob => {
          const file = new File([blob], 'sakura.png', { type: 'image/png' });
          navigator.share({
            files: [file],
            title: '銀座の桜',
            text: '銀座の空に桜を咲かせました！'
          }).catch(console.error);
        });
    } else {
      // 共有機能がない場合は直接ダウンロード
      link.click();
    }
  } catch (err) {
    console.error("画像の生成に失敗しました。カメラのクロスドメイン制限の可能性があります。", err);
    alert("このブラウザでは直接保存ができないため、通常のスクリーンショットをご利用ください。");
  }

  // フラッシュ演出（視覚的なフィードバック）
  const flash = document.createElement('div');
  flash.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:white;z-index:10001;pointer-events:none;';
  document.body.appendChild(flash);
  setTimeout(() => {
    flash.style.transition = 'opacity 0.4s';
    flash.style.opacity = '0';
    setTimeout(() => document.body.removeChild(flash), 400);
  }, 50);
});
    </script>
  </body>
</html>