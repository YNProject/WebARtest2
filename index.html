<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ginza Sakura Sky - Loop</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 9999; color: white; flex-direction: column;
        font-family: sans-serif;
      }
      button {
        padding: 15px 35px; font-size: 18px; background: #FFB6C1;
        border: none; border-radius: 30px; cursor: pointer; color: #444; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <div id="overlay">
      <h2 style="margin-bottom: 20px;">銀座の空に桜を咲かせます</h2>
      <button id="start-btn">ARを開始する</button>
    </div>

    <a-scene id="scene" embedded vr-mode-ui="enabled: false" 
             arjs="sourceType: webcam; debugUIEnabled: false;">
      
      <a-assets>
        <a-mixin id="petal" 
                 geometry="primitive: plane; width: 0.05; height: 0.05" 
                 material="color: #FFB6C1; side: double; transparent: true; opacity: 0.8; shader: flat">
        </a-mixin>
      </a-assets>

      <a-entity camera look-controls="enabled: true"></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('#scene');
      const startBtn = document.querySelector('#start-btn');
      const overlay = document.querySelector('#overlay');

      const MAX_PETALS = 350; // 空間に漂う花びらの合計数

      startBtn.addEventListener('click', function() {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
              if (permissionState === 'granted') {
                initAR();
              } else {
                alert('スマホの傾きセンサーを許可してください');
              }
            })
            .catch(console.error);
        } else {
          initAR();
        }
      });

      function initAR() {
        overlay.style.display = 'none';
        // 初期の花びらを時間差で生成
        for (let i = 0; i < MAX_PETALS; i++) {
          setTimeout(() => createPetal(), Math.random() * 10000);
        }
      }

      function createPetal() {
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        
        // 周囲360度、半径2m〜18mの広範囲に配置
        const angle = Math.random() * Math.PI * 2;
        const radius = 2 + Math.random() * 16;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        
        // 開始位置（上空）と終了位置（足元より下まで突き抜ける）
        const startY = 8 + Math.random() * 5; 
        const endY = -10; // 床で止めず、はるか下まで落とす

        petal.setAttribute('position', `${x} ${startY} ${z}`);
        
        // 落下速度（10秒〜20秒かけてゆっくり）
        const fallDuration = 10000 + Math.random() * 10000;

        petal.setAttribute('animation__fall', {
          property: 'position',
          to: `${x + (Math.random() - 0.5) * 4} ${endY} ${z + (Math.random() - 0.5) * 4}`,
          dur: fallDuration,
          easing: 'linear',
          loop: false
        });

        // ひらひら回るアニメーション
        petal.setAttribute('animation__rotate', {
          property: 'rotation',
          to: `${Math.random() * 360} ${Math.random() * 360} ${Math.random() * 360}`,
          dur: 3000 + Math.random() * 2000,
          loop: true
        });

        sceneEl.appendChild(petal);

        // 画面外（下方）に消えたら削除して、新しいのを上から出す
        setTimeout(() => {
          if (petal.parentNode) {
            petal.parentNode.removeChild(petal);
            createPetal();
          }
        }, fallDuration);
      }
    </script>
  </body>
</html>