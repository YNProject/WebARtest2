<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ginza Sakura - Plane Detection Edition</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 9999; color: white; flex-direction: column;
        font-family: sans-serif; text-align: center;
      }
      #start-btn {
        padding: 15px 35px; font-size: 18px; background: #FFB6C1;
        border: none; border-radius: 30px; cursor: pointer; color: #444; font-weight: bold;
      }
      #shutter-btn {
        position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
        width: 76px; height: 76px; background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%; display: none; align-items: center; justify-content: center; border: 4px solid white; z-index: 10000;
      }
      #shutter-btn-inner { width: 60px; height: 60px; background-color: white; border-radius: 50%; }
      .msg { position: fixed; top: 20px; width: 100%; text-align: center; color: white; z-index: 10000; font-family: sans-serif; pointer-events: none;}
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">

    <div id="overlay">
      <h2>銀座の地面に桜を咲かせよう</h2>
      <p>床をゆっくり映してリングが出たらタップ</p>
      <button id="start-btn">ARを開始する</button>
    </div>

    <div id="msg" class="msg" style="display:none;">床をスキャン中...</div>
    <div id="shutter-btn"><div id="shutter-btn-inner"></div></div>

    <a-scene 
      webxr="optionalFeatures: hit-test, local-floor; overlayElement: #overlay;"
      ar-hit-test="target: #sakura-anchor; type: footprint;"
      vr-mode-ui="enabled: false"
      screenshot>
      
      <a-assets>
        <img id="sakura-white-img" src="img/sakuraWhite.png">
        <a-asset-item id="sakura-tree-model" src="model/sakura.glb"></a-asset-item>
        <a-mixin id="petal" geometry="primitive: plane; width: 0.1; height: 0.1" 
                  material="src: #sakura-white-img; transparent: true; alphaTest: 0.5; side: double;"></a-mixin>
      </a-assets>

      <a-entity id="reticle" gltf-model="url(https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf)" scale="0.1 0.1 0.1" visible="false"></a-entity>
      <a-ring id="guide-ring" rotation="-90 0 0" radius-inner="0.1" radius-outer="0.15" color="#FFB6C1" visible="false"></a-ring>

      <a-entity id="sakura-anchor" visible="false">
        <a-entity gltf-model="#sakura-tree-model" scale="1 1 1"></a-entity>
        <a-entity id="petal-generator" position="0 2 0"></a-entity>
      </a-entity>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('a-scene');
      const startBtn = document.querySelector('#start-btn');
      const shutterBtn = document.querySelector('#shutter-btn');
      const ring = document.querySelector('#guide-ring');
      const anchor = document.querySelector('#sakura-anchor');
      const msg = document.querySelector('#msg');

      let petals = [];
      let isPlaced = false;

      startBtn.addEventListener('click', () => {
        // WebXRのARモードを開始
        sceneEl.enterVR();
        document.querySelector('#overlay').style.display = 'none';
        msg.style.display = 'block';
      });

      // 平面検知の処理
      sceneEl.addEventListener('ar-hit-test-select', (event) => {
        if (!isPlaced) {
          // 最初にタップした場所に木を固定
          isPlaced = true;
          anchor.setAttribute('visible', 'true');
          shutterBtn.style.display = 'flex';
          msg.innerText = "桜が咲きました！";
          setTimeout(() => msg.style.display = 'none', 3000);
          
          // 花びら生成開始
          setInterval(createPetal, 200);
        }
      });

      // フレーム毎のリングの表示制御
      sceneEl.addEventListener('ar-hit-test-start', () => {
        console.log("Hit test started");
      });

      sceneEl.addEventListener('ar-hit-test-achieved', (event) => {
        if (!isPlaced) {
          ring.setAttribute('visible', 'true');
          // マーカーを床の座標に合わせる
          ring.setAttribute('position', event.detail.position);
          msg.innerText = "タップして桜を植える";
        } else {
          ring.setAttribute('visible', 'false');
        }
      });

      function createPetal() {
        if (!isPlaced) return;
        
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        
        // 木の周りにランダムに配置
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * 3;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        const startY = 3 + Math.random() * 2;

        const pos = anchor.getAttribute('position');
        petal.setAttribute('position', `${pos.x + x} ${pos.y + startY} ${pos.z + z}`);
        petal.setAttribute('material', 'color: #FFB6C1');

        // 落下アニメーション
        petal.setAttribute('animation__fall', {
          property: 'position',
          to: `${pos.x + x + (Math.random()-0.5)*2} ${pos.y} ${pos.z + z + (Math.random()-0.5)*2}`,
          dur: 5000 + Math.random() * 3000,
          easing: 'linear'
        });

        sceneEl.appendChild(petal);
        
        setTimeout(() => {
          if (petal.parentNode) petal.parentNode.removeChild(petal);
        }, 8000);
      }

      // シャッター機能（WebXRではvideo要素の取得方法が異なるため、簡易保存を実装）
      shutterBtn.addEventListener('click', () => {
        const canvas = sceneEl.components.screenshot.getCanvas('perspective');
        const link = document.createElement('a');
        link.download = 'ginza-sakura.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    </script>
  </body>
</html>