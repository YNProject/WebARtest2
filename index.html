<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ginza Sakura Sky - Image Version</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 9999; color: white; flex-direction: column;
        font-family: sans-serif;
      }
      button {
        padding: 15px 35px; font-size: 18px; background: #FFB6C1;
        border: none; border-radius: 30px; cursor: pointer; color: #444; font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <div id="overlay">
      <h2 style="margin-bottom: 20px;">銀座の空に桜を咲かせます</h2>
      <button id="start-btn">ARを開始する</button>
    </div>

    <a-scene id="scene" embedded vr-mode-ui="enabled: false" 
             arjs="sourceType: webcam; debugUIEnabled: false;">
      
      <a-assets>
        <img id="sakura-img" src="img/sakura.png">
        
        <a-mixin id="petal" 
                 geometry="primitive: plane; width: 0.12; height: 0.12" 
                 material="src: #sakura-img; transparent: true; alphaTest: 0.5; side: double; shader: flat">
        </a-mixin>
      </a-assets>

      <a-entity camera look-controls="enabled: true"></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('#scene');
const startBtn = document.querySelector('#start-btn');
const overlay = document.querySelector('#overlay');

const MAX_PETALS = 600; // 舞い落ちる花びらの数
let petals = [];        // 風の制御用に、舞い落ちる花びらのみを管理する配列

// --- 1. センサー許可と開始の処理 ---
startBtn.addEventListener('click', function() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          initAR();
        } else {
          alert('センサーの許可が必要です。ブラウザの設定で「動作と方向」をオンにしてください。');
        }
      })
      .catch(console.error);
  } else {
    initAR();
  }
});

// --- 2. 初期化 ---
function initAR() {
  overlay.style.display = 'none';

  // 【新演出】空中に「桜の塊（木）」を数箇所に配置
  // createTreePart(中心のX, 中心のZ, 花の数)
  createTreePart(0, -6, 150);    // 正面
  createTreePart(5, -5, 120);    // 右前方
  createTreePart(-5, -5, 120);   // 左前方
  createTreePart(2, -10, 100);   // 少し奥

  // 舞い落ちる花びらをじわじわ生成
  for (let i = 0; i < MAX_PETALS; i++) {
    setTimeout(() => createPetal(), Math.random() * 15000);
  }

  // 不規則な「風」のサイクルを開始
  scheduleNextWind();
}

// --- 3. 桜の「塊（木）」を作る関数 ---
function createTreePart(centerX, centerZ, count) {
  for (let i = 0; i < count; i++) {
    const leaf = document.createElement('a-entity');
    leaf.setAttribute('mixin', 'petal');
    
    // かたまりの広がりを定義（半径2m程度の範囲にランダム配置）
    const angle = Math.random() * Math.PI * 2;
    const radius = Math.random() * 2.5; 
    const x = centerX + Math.cos(angle) * radius;
    const z = centerZ + Math.sin(angle) * radius;
    const y = 5 + Math.random() * 3; // 地上5m〜8mの高さ

    leaf.setAttribute('position', `${x} ${y} ${z}`);

    // その場で小さくゆらゆらさせるアニメーション
    leaf.setAttribute('animation__sway', {
      property: 'position',
      to: `${x + (Math.random() - 0.5) * 0.4} ${y + (Math.random() - 0.5) * 0.4} ${z}`,
      dur: 2000 + Math.random() * 3000,
      dir: 'alternate',
      loop: true,
      easing: 'easeInOutSine'
    });

    // わずかに回転させてキラキラさせる
    leaf.setAttribute('animation__rotate', {
      property: 'rotation',
      to: `${Math.random() * 360} ${Math.random() * 360} ${Math.random() * 360}`,
      dur: 5000 + Math.random() * 5000,
      loop: true,
      easing: 'linear'
    });

    sceneEl.appendChild(leaf);
  }
}

// --- 4. 舞い落ちる花びらの生成（循環） ---
function createPetal() {
  const petal = document.createElement('a-entity');
  petal.setAttribute('mixin', 'petal');
  
  const angle = Math.random() * Math.PI * 2;
  const radius = 2 + Math.random() * 18; // 半径18mまで広げる
  const x = Math.cos(angle) * radius;
  const z = Math.sin(angle) * radius;
  
  const startY = 8 + Math.random() * 5; 
  const endY = -10; 

  petal.setAttribute('position', `${x} ${startY} ${z}`);
  
  const fallDuration = 10000 + Math.random() * 12000;

  petal.setAttribute('animation__fall', {
    property: 'position',
    to: `${x + (Math.random() - 0.5) * 4} ${endY} ${z + (Math.random() - 0.5) * 4}`,
    dur: fallDuration,
    easing: 'linear',
    loop: false
  });

  petal.setAttribute('animation__rotate', {
    property: 'rotation',
    to: `${Math.random() * 360} ${Math.random() * 720} ${Math.random() * 360}`,
    dur: 3000 + Math.random() * 3000,
    loop: true
  });

  sceneEl.appendChild(petal);
  petals.push(petal); 

  setTimeout(() => {
    if (petal.parentNode) {
      petal.parentNode.removeChild(petal);
      petals = petals.filter(p => p !== petal);
      createPetal();
    }
  }, fallDuration);
}

// --- 5. 不規則な風の制御 ---
function scheduleNextWind() {
  const nextWindDelay = 10000 + Math.random() * 15000;
  setTimeout(() => {
    blowWind();
    scheduleNextWind();
  }, nextWindDelay);
}

function blowWind() {
  const windStrength = 10 + Math.random() * 20;
  const windAngle = Math.random() * Math.PI * 2;
  const windX = Math.cos(windAngle) * windStrength;
  const windZ = Math.sin(windAngle) * windStrength;
  const windDuration = 5000 + Math.random() * 5000;

  petals.forEach(petal => {
    const currentPos = petal.getAttribute('position');
    petal.setAttribute('animation__fall', {
      to: `${currentPos.x + windX} -10 ${currentPos.z + windZ}`,
      dur: windDuration,
      easing: 'easeOutQuad'
    });
  });
}
    </script>
  </body>
</html>