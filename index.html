<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene id="scene" embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false;">
      
      <a-assets>
        <a-mixin id="petal" 
                 geometry="primitive: plane; width: 0.05; height: 0.05" 
                 material="color: #FFB6C1; side: double; transparent: true; opacity: 0.8">
        </a-mixin>
      </a-assets>

      <a-entity camera></a-entity>

    </a-scene>

    <script>
      const sceneEl = document.querySelector('#scene'); // 追加先をsceneに変更
      
      function createPetal(isExtra = false) {
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        
        // 360度広がるように、XとZの両方をランダムな円状にします
        // 半径15mの範囲にばらまく
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * 15;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        
        const startY = 5 + Math.random() * 5;
        const endY = -1.6;

        petal.setAttribute('position', `${x} ${startY} ${z}`);

        const fallDuration = isExtra ? 2000 : (10000 + Math.random() * 10000); 
        petal.setAttribute('animation__fall', {
          property: 'position',
          to: `${x + (Math.random() - 0.5) * 2} ${endY} ${z + (Math.random() - 0.5) * 2}`,
          dur: fallDuration,
          easing: 'easeInQuad',
          loop: false
        });

        petal.setAttribute('animation__rotate', {
          property: 'rotation',
          to: `${Math.random() * 360} ${Math.random() * 360} ${Math.random() * 360}`,
          dur: 3000,
          loop: true
        });

        sceneEl.appendChild(petal); // cameraではなくsceneに追加！

        setTimeout(() => {
          if (petal.parentNode) petal.parentNode.removeChild(petal);
        }, fallDuration + 5000);
      }

      // 最初は自分の周り360度に500枚降らせる
      for (let i = 0; i < 500; i++) {
        setTimeout(() => createPetal(), Math.random() * 10000);
      }

      // スマホを振る検知（前回のコードと同じ）
      let lastUpdate = 0;
      let lastX, lastY, lastZ;
      const threshold = 15;
      window.addEventListener('devicemotion', (event) => {
        const acceleration = event.accelerationIncludingGravity;
        const curTime = new Date().getTime();
        if ((curTime - lastUpdate) > 100) {
          const diffTime = curTime - lastUpdate;
          lastUpdate = curTime;
          const speed = Math.abs(acceleration.x + acceleration.y + acceleration.z - lastX - lastY - lastZ) / diffTime * 10000;
          if (speed > threshold) {
            for(let i=0; i<20; i++) createPetal(true);
          }
          lastX = acceleration.x; lastY = acceleration.y; lastZ = acceleration.z;
        }
      });
    </script>
  </body>
</html>