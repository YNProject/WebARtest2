const sceneEl = document.querySelector('#scene');
const startBtn = document.querySelector('#start-btn');
const overlay = document.querySelector('#overlay');

const MAX_PETALS = 400; // 常に空間に存在する花びらの数

startBtn.addEventListener('click', function() {
  if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(permissionState => {
        if (permissionState === 'granted') {
          initAR();
        } else {
          alert('センサーの許可が必要です。設定からブラウザの「動作と方向」を許可してください。');
        }
      })
      .catch(console.error);
  } else {
    initAR();
  }
});

function initAR() {
  overlay.style.display = 'none';
  // 最初に一気に降らせるのではなく、少しずつ生成して循環を開始
  for (let i = 0; i < MAX_PETALS; i++) {
    // 降り始めをバラけさせるためにディレイをかける
    setTimeout(() => createPetal(), Math.random() * 15000);
  }
}

function createPetal() {
  const petal = document.createElement('a-entity');
  petal.setAttribute('mixin', 'petal');
  
  // 360度、半径2m〜15mの範囲にランダム配置
  const angle = Math.random() * Math.PI * 2;
  const radius = 2 + Math.random() * 13;
  const x = Math.cos(angle) * radius;
  const z = Math.sin(angle) * radius;
  const startY = 6 + Math.random() * 4; // 少し高めの位置から
  const endY = -1.6; // 床（目線から1.6m下）

  petal.setAttribute('position', `${x} ${startY} ${z}`);
  
  // 寿命（落下時間）の設定：8秒〜18秒
  const lifeSpan = 8000 + Math.random() * 10000;

  petal.setAttribute('animation__fall', {
    property: 'position',
    to: `${x + (Math.random() - 0.5) * 2} ${endY} ${z + (Math.random() - 0.5) * 2}`,
    dur: lifeSpan,
    easing: 'linear',
    loop: false
  });

  petal.setAttribute('animation__rotate', {
    property: 'rotation',
    to: `${Math.random() * 360} ${Math.random() * 360} ${Math.random() * 360}`,
    dur: 3000 + Math.random() * 2000,
    loop: true
  });

  sceneEl.appendChild(petal);

  // --- 寿命が来たら消して、新しい花びらを生成するサイクル ---
  // 床に落ちてから3秒ほど余韻で置いておき、その後消去＆新規作成
  setTimeout(() => {
    if (petal.parentNode) {
      petal.parentNode.removeChild(petal);
      createPetal(); // ★ここで新しい花びらを補充！
    }
  }, lifeSpan + 3000); 
}