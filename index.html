<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ginza Sakura Sky - Fade Out Edition</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      #overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); display: flex; justify-content: center;
        align-items: center; z-index: 9999; color: white; flex-direction: column;
        font-family: sans-serif; text-align: center;
      }
      #start-btn {
        padding: 15px 35px; font-size: 18px; background: #fff;
        border: none; border-radius: 30px; cursor: pointer; color: #444; font-weight: bold;
      }
      #shutter-wrapper {
        position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
        display: none; align-items: center; justify-content: center; z-index: 10000;
      }
      #shutter-btn {
        width: 76px; height: 76px; background-color: rgba(255, 255, 255, 0.3);
        border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white;
      }
      #shutter-btn-inner { width: 60px; height: 60px; background-color: white; border-radius: 50%; }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden;">
    
    <div id="overlay">
      <h2 style="margin-bottom: 10px;">銀座の街に桜を咲かせよう</h2>
      <p style="margin-bottom: 20px;">画面をタップして桜を植えてください</p>
      <button id="start-btn">ARを開始する</button>
    </div>

    <div id="shutter-wrapper">
      <div id="shutter-btn"><div id="shutter-btn-inner"></div></div>
    </div>

    <a-scene id="scene" embedded vr-mode-ui="enabled: false" 
              arjs="sourceType: webcam; debugUIEnabled: false;"
              screenshot
              gl="preserveDrawingBuffer: true;">
      
      <a-assets>
        <img id="sakura-white-img" src="img/sakuraWhite.png">
        <img id="cloud-img" src="img/cloud.png">
        <img id="kage-img" src="img/kage.png">
        <a-asset-item id="sakura-tree-model" src="model/sakura.glb"></a-asset-item>
        
        <a-mixin id="petal" geometry="primitive: plane; width: 0.12; height: 0.12" 
                  material="src: #sakura-white-img; transparent: true; alphaTest: 0.6; side: double; shader: flat"></a-mixin>
        <a-mixin id="cloud-mixin" material="src: #cloud-img; transparent: true; alphaTest: 0.1; side: double; shader: flat; depthTest: false;"></a-mixin>
      </a-assets>

      <a-entity id="ambient-light" light="type: ambient; color: #ffffff; intensity: 1.2"></a-entity>
      <a-entity camera look-controls="enabled: true; touchEnabled: false;" far="1000"></a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('#scene');
      const startBtn = document.querySelector('#start-btn');
      const overlay = document.querySelector('#overlay');
      const shutterWrapper = document.querySelector('#shutter-wrapper');
      const ambientLight = document.querySelector('#ambient-light');

      let placedGroups = []; 
      const MAX_TREES = 4;
      let treeCounter = 0; 
      
      let petals = [];
      let petalColor = "#ffffff";
      let touchStartX = 0;
      let touchStartY = 0;

      startBtn.addEventListener('click', function() {
        overlay.style.display = 'none';
        shutterWrapper.style.display = 'flex';
        updateLightingByTime();
      });

      window.addEventListener('mousedown', (e) => {
        if (overlay.style.display !== 'none' || e.target.closest('#shutter-wrapper')) return;
        placeNewTree(e.clientX, e.clientY);
      });

      function placeNewTree(clientX, clientY) {
        const screenY = clientY / window.innerHeight;
        const distance = 5 + (1 - Math.max(0.2, screenY)) * 25; 

        const camera = document.querySelector('[camera]').object3D;
        const direction = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
        direction.y = 0; 
        direction.normalize();

        const targetX = camera.position.x + direction.x * distance;
        const targetZ = camera.position.z + direction.z * distance;

        const masterGroup = document.createElement('a-entity');
        masterGroup.setAttribute('position', `${targetX} -8 ${targetZ}`);

        // --- 1. 木のエンティティ（回転あり） ---
        const treeEntity = document.createElement('a-entity');
        const randomRotation = Math.random() * 360;
        treeEntity.setAttribute('rotation', `0 ${randomRotation} 0`);

        const model = document.createElement('a-entity');
        model.setAttribute('gltf-model', '#sakura-tree-model');
        model.setAttribute('scale', '0.7 0.7 0.7');
        
        // GLBの透明度操作を可能にするための初期化
        model.addEventListener('model-loaded', () => {
          model.object3D.traverse((node) => {
            if (node.isMesh) {
              node.material.transparent = true;
              node.material.opacity = 1;
            }
          });
        });

        treeEntity.appendChild(model);

        const shadow = document.createElement('a-entity');
        treeCounter++;
        const shadowY = 0.05 + (treeCounter % 10 * 0.005);
        shadow.setAttribute('geometry', 'primitive: plane; width: 6; height: 6');
        shadow.setAttribute('material', {
          src: '#kage-img', transparent: true, opacity: 0.4, depthWrite: false, shader: 'flat'
        });
        shadow.setAttribute('rotation', '-90 0 0');
        shadow.setAttribute('position', `0 ${shadowY} 0`);
        treeEntity.appendChild(shadow);

        masterGroup.appendChild(treeEntity);

        // --- 2. 雲のコンテナ（回転なし） ---
        const cloudContainer = document.createElement('a-entity');
        masterGroup.appendChild(cloudContainer);
        createClouds(cloudContainer);

        sceneEl.appendChild(masterGroup);
        placedGroups.push(masterGroup);

        if (placedGroups.length > MAX_TREES) {
          const oldest = placedGroups.shift();
          removeWithFade(oldest);
        }

        if (placedGroups.length === 1 && petals.length === 0) {
          for (let i = 0; i < 200; i++) { 
            setTimeout(() => createPetal(), Math.random() * 5000); 
          }
        }
      }

      function removeWithFade(group) {
        // 木のモデル、雲、影のすべてを探索してフェードアウト
        const duration = 2000;
        const startTime = performance.now();

        function animateFade() {
          const now = performance.now();
          const progress = Math.min((now - startTime) / duration, 1);
          const currentOpacity = 1 - progress;

          group.object3D.traverse((node) => {
            if (node.material) {
              node.material.transparent = true;
              node.material.opacity = node.userData.originalOpacity !== undefined 
                ? node.userData.originalOpacity * currentOpacity 
                : currentOpacity * 0.4; // 影などは元々0.4なので調整
            }
          });

          if (progress < 1) {
            requestAnimationFrame(animateFade);
          } else {
            if (group.parentNode) group.parentNode.removeChild(group);
          }
        }
        
        // 最初の透明度を記録（雲や影の元々の薄さを維持するため）
        group.object3D.traverse((node) => {
          if (node.material) node.userData.originalOpacity = node.material.opacity;
        });

        requestAnimationFrame(animateFade);
      }

      function createPetal() {
        if (placedGroups.length === 0) return;
        const petal = document.createElement('a-entity');
        petal.setAttribute('mixin', 'petal');
        const angle = (Math.random() - 0.5) * (Math.PI * 0.66); 
        const radius = 1 + Math.random() * 10; 
        const x = Math.sin(angle) * radius;
        const z = -Math.cos(angle) * radius;
        petal.setAttribute('position', `${x} 1.5 ${z}`);
        petal.setAttribute('rotation', `${Math.random()*360} ${Math.random()*360} ${Math.random()*360}`);
        petal.setAttribute('material', `color: ${petalColor}; opacity: 0.8;`);
        const dur = 15000 + Math.random() * 10000;
        petal.setAttribute('animation__fall', { property: 'position', to: `${x + (Math.random()-0.5)*3} -5 ${z - 2}`, dur: dur, easing: 'linear' });
        petal.setAttribute('animation__rotate', { property: 'rotation', to: `${Math.random()*360 + 360} ${Math.random()*360 + 720} ${Math.random()*360 + 360}`, dur: 6000 + Math.random() * 2000, loop: true, easing: 'linear' });
        sceneEl.appendChild(petal);
        petals.push(petal);
        setTimeout(() => { 
          if (petal.parentNode) { petal.parentNode.removeChild(petal); petals = petals.filter(p => p !== petal); createPetal(); } 
        }, dur);
      }

      function createClouds(parentEntity) {
        const pinkColors = ['#FFC0CB', '#FFB6C1', '#FFE4E1', '#FFF0F5'];
        for (let i = 0; i < 15; i++) {
          const cloud = document.createElement('a-entity');
          cloud.setAttribute('mixin', 'cloud-mixin');
          const angle = Math.random() * Math.PI * 2;
          const radius = 2 + Math.random() * 6;
          const x = Math.cos(angle) * radius;
          const z = Math.sin(angle) * radius;
          const y = 4 + Math.random() * 3; 
          cloud.setAttribute('position', `${x} ${y} ${z}`);
          const randomColor = pinkColors[Math.floor(Math.random() * pinkColors.length)];
          cloud.setAttribute('material', `color: ${randomColor}; opacity: 0.35`);
          const size = 5 + Math.random() * 5;
          cloud.setAttribute('geometry', `primitive: plane; width: ${size}; height: ${size * 0.6}`);
          parentEntity.appendChild(cloud);
        }
      }

      function updateLightingByTime() {
        const hour = new Date().getHours();
        if (hour >= 16 && hour < 18) {
          ambientLight.setAttribute('light', 'color: #fffafa; intensity: 1.1'); 
          petalColor = "#ffffff";
        } else if (hour >= 18 || hour < 6) {
          ambientLight.setAttribute('light', 'color: #f0f0ff; intensity: 0.8'); 
          petalColor = "#f8f8ff"; 
        }
      }

      window.addEventListener('touchstart', (e) => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; });
      window.addEventListener('touchend', (e) => {
        const diffX = e.changedTouches[0].clientX - touchStartX;
        const diffZ = e.changedTouches[0].clientY - touchStartY;
        if (Math.abs(diffX) > 30 || Math.abs(diffZ) > 30) {
          petals.forEach(p => {
            const pos = p.getAttribute('position');
            p.setAttribute('animation', { property: 'position', to: `${pos.x + diffX/15} -10 ${pos.z + diffZ/15}`, dur: 6000, easing: 'easeOutQuad' });
          });
        }
      });

      document.querySelector('#shutter-btn').addEventListener('click', async function() {
        const video = document.querySelector('video');
        const aSceneCanvas = sceneEl.components.screenshot.getCanvas('perspective');
        const finalCanvas = document.createElement("canvas");
        finalCanvas.width = video.videoWidth; finalCanvas.height = video.videoHeight;
        const ctx = finalCanvas.getContext("2d");
        ctx.drawImage(video, 0, 0, finalCanvas.width, finalCanvas.height);
        ctx.drawImage(aSceneCanvas, 0, 0, finalCanvas.width, finalCanvas.height);
        const dataURL = finalCanvas.toDataURL('image/png');
        const flash = document.createElement('div');
        flash.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:white;z-index:10001;pointer-events:none;';
        document.body.appendChild(flash);
        setTimeout(() => { flash.style.transition = 'opacity 0.4s'; flash.style.opacity = '0'; setTimeout(() => document.body.removeChild(flash), 400); }, 50);
        try {
          if (navigator.share) {
            const blob = await (await fetch(dataURL)).blob();
            const file = new File([blob], `sakura-${Date.now()}.png`, { type: 'image/png' });
            await navigator.share({ files: [file], title: '銀座の桜' });
          } else {
            const link = document.createElement('a');
            link.download = `sakura-${Date.now()}.png`; link.href = dataURL; link.click();
          }
        } catch (err) { console.log("Share skipped or failed", err); }
      });
    </script>
  </body>
</html>